<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Mapa</title>
</head>

<body>
  <div id="mapa" style="width: 700px; height: 500px; border: solid 1px #ccc">

  </div>
  <button onclick="CargarZonas(0)">Zona 1</button>
  <button onclick="CargarZonas(1)">Zona 3</button>
</body>
<script>
  var mapa;
  var marcadores = [];
  var zona = {};

  var zonas = [];
  var poligonos = [];
  var opacidadMapas = 0.3;
  var limiteses = [];
  var coords = [];

  function iniciarMap() {
    mapa = new google.maps.Map(document.getElementById("mapa"), {
      zoom: 16,
      center: {
        lat: 38.9922807,
        lng: -0.1735785
      },
      streetViewControl: false
    });

    mapa.setMapTypeId('hybrid');
    getSensores(mapa);
    getZonas(mapa);
  } //iniciarMap

  function CargarZonas(índice) {
    setBounds(mapa, poligonos[índice])
    console.log(poligonos[índice])
  }

  function getZonas(mapa) {
    fetch('/zona?id=1').then(function(res) {
      if (res.status == 404 || res.status == 500) {
        alert('Error de servidor')
        window.location.href = 'InicioSesion.html'
      } else {
        return res.json()
      } //else
    }).then(function(zones) {
      for (let i of zones) {
        zonas.push(i);
      }; //for
      for (let i = 0; i < zonas.length; i++) {
        poligonos[i] = new google.maps.Polygon({
          paths: zonas[i].vertices,
          fillColor: zonas[i].color,
          fillOpacity: opacidadMapas,
          strokeColor: zonas[i].color,
          strokeOpacity: opacidadMapas
        }) //constructor
      } //for

    }) //then
  } //getZonas

  function getSensores(mapa) {
    fetch('/sensores').then(function(respuesta) {
      return respuesta.json()
    }).then(function(res) {
      if (res.status > 400) {
        alert('Error de servidor');
      } else {
        for (let i = 0; i < res.length; i++) {
          marcadores[i] = new google.maps.Marker({
            position: res[i],
            map: mapa,
            title: 'Sensor ' + JSON.stringify(i + 1)
          })
          marcadores[i].addListener('click', function() {
            console.log('Soy el sensor ' + marcadores[i].title);
          })
        } //for
      } //else
    }) //then
  } //getSensores

  function setBounds(mapa, poligono) {
    poligono.setMap(mapa);
    let limites = new google.maps.LatLngBounds();
    let vertices = poligono.getPath()
    console.log(vertices)
    for (let i = 0; i < vertices.length; i++) {
      vertices[i].lat = parseFloat(vertices[i].lat)
      vertices[i].lng = parseFloat(vertices[i].lng)
      limites.extend(vertices[i]);
    }
    mapa.fitBounds(limites);
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4CfoqowZGnOpAw3wDFvjc2im84GK_EHk&callback=iniciarMap">
</script>

</html>
